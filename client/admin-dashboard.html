<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Admin Dashboard</h1>
            <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg shadow">Logout</button>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Bulk User Management</h2>
            <input type="file" id="userBulkFile" accept=".json,.xlsx,.xls,.csv,.pdf" class="mb-2">
            <button id="userUploadBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded-lg shadow">Upload User File</button>
            <p id="userUploadStatus" class="mt-3 text-sm text-gray-600"></p>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">User List</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID / Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assignment</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userList" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75"></div>
            <div class="bg-white rounded-lg shadow-xl transform w-full max-w-lg mx-4">
                <form id="editForm" class="p-8 space-y-4">
                    <h2 class="text-2xl font-bold">Edit User</h2>
                    <input type="hidden" id="editUserId">
                    <div>
                        <label for="editName" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="editName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label for="editRole" class="block text-sm font-medium text-gray-700">Role</label>
                        <select id="editRole" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            <option value="student">Student</option>
                            <option value="faculty">Faculty</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div id="studentFields" class="space-y-4">
                         <div>
                            <label for="editRollNumber" class="block text-sm font-medium text-gray-700">Roll Number</label>
                            <input type="text" id="editRollNumber" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="editBatch" class="block text-sm font-medium text-gray-700">Batch</label>
                            <select id="editBatch" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                <option value="N">N</option><option value="P">P</option><option value="Q">Q</option>
                            </select>
                        </div>
                        <div>
                            <label for="editSemester" class="block text-sm font-medium text-gray-700">Semester</label>
                            <input type="number" id="editSemester" min="1" max="8" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                    </div>
                    <div id="facultyFields" class="hidden">
                        <label for="editHandledBatches" class="block text-sm font-medium text-gray-700">Handled Batches (JSON format)</label>
                        <textarea id="editHandledBatches" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 font-mono" placeholder='[{"batch": "N", "semester": 1}]'></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancelEdit" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Cancel</button>
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const axiosInstance = axios.create({ baseURL: '/api' });
        const userList = document.getElementById('userList');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
            
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('userUploadBtn').addEventListener('click', handleBulkUserUpload);
            document.getElementById('cancelEdit').addEventListener('click', () => editModal.classList.add('hidden'));
            editForm.addEventListener('submit', handleSaveChanges);
            
            document.getElementById('editRole').addEventListener('change', (e) => {
                const isStudent = e.target.value === 'student';
                const isFaculty = e.target.value === 'faculty';
                document.getElementById('studentFields').style.display = isStudent ? 'block' : 'none';
                document.getElementById('facultyFields').style.display = isFaculty ? 'block' : 'none';
            });
        });

        async function loadUsers() {
            try {
                const res = await axiosInstance.get('/auth/get_users');
                renderUsers(res.data);
            } catch (error) {
                console.error('Failed to load users:', error);
                if (error.response.status === 401 || error.response.status === 403) {
                    window.location.href = '/student-login.html';
                }
            }
        }

        function renderUsers(users) {
            userList.innerHTML = users.map(user => {
                let assignmentHtml = 'N/A';
                if (user.role === 'student' && user.batch) {
                    assignmentHtml = `Batch ${user.batch} - Sem ${user.semester}`;
                } else if (user.role === 'faculty' && user.handledBatches && user.handledBatches.length > 0) {
                    assignmentHtml = user.handledBatches.map(b => `B:${b.batch}/S:${b.semester}`).join(', ');
                }
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${user.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${user.user_id}</div>
                            <div class="text-sm text-gray-500">${user.role}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${assignmentHtml}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="openEditModal('${encodeURIComponent(JSON.stringify(user))}')" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                            <button onclick="deleteUser('${user._id}')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        window.openEditModal = (encodedUser) => {
            const user = JSON.parse(decodeURIComponent(encodedUser));
            document.getElementById('editUserId').value = user._id;
            document.getElementById('editName').value = user.name;
            document.getElementById('editRole').value = user.role;
            
            document.getElementById('editRole').dispatchEvent(new Event('change'));

            document.getElementById('editRollNumber').value = user.roll_number || '';
            document.getElementById('editBatch').value = user.batch || 'N';
            document.getElementById('editSemester').value = user.semester || 1;
            document.getElementById('editHandledBatches').value = JSON.stringify(user.handledBatches || [], null, 2);
            
            editModal.classList.remove('hidden');
        }

        async function handleSaveChanges(e) {
            e.preventDefault();
            const userId = document.getElementById('editUserId').value;
            const role = document.getElementById('editRole').value;
            
            const payload = {
                name: document.getElementById('editName').value,
                role: role,
            };

            if (role === 'student') {
                payload.roll_number = document.getElementById('editRollNumber').value;
                payload.batch = document.getElementById('editBatch').value;
                payload.semester = parseInt(document.getElementById('editSemester').value);
            } else if (role === 'faculty') {
                try {
                    payload.handledBatches = JSON.parse(document.getElementById('editHandledBatches').value);
                } catch (error) {
                    alert('Invalid JSON in Handled Batches field.');
                    return;
                }
            }
            
            try {
                await axiosInstance.put(`/auth/update/users/${userId}`, payload);
                editModal.classList.add('hidden');
                loadUsers();
            } catch (error) {
                console.error('Failed to update user:', error);
                alert('Error: ' + (error.response?.data?.message || 'Could not save changes.'));
            }
        }

        window.deleteUser = async (userId) => {
            if (!confirm('Are you sure you want to delete this user?')) return;
            try {
                await axiosInstance.delete(`/auth/delete/users/${userId}`);
                loadUsers();
            } catch (error) {
                console.error('Failed to delete user:', error);
                alert('Could not delete user.');
            }
        }

        async function handleLogout() {
            try {
                await axiosInstance.post('/auth/logout');
            } finally {
                window.location.href = '/student-login.html';
            }
        }
        
        async function handleBulkUserUpload() {
          const fileInput = document.getElementById('userBulkFile');
          const status = document.getElementById('userUploadStatus');
          const file = fileInput.files[0];
          if (!file) { status.textContent = 'Please select a user file.'; return; }

          const formData = new FormData();
          formData.append('file', file);
          status.textContent = "Uploading users...";
          try {
            const res = await axiosInstance.post(`/auth/register/bulk`, formData);
            status.textContent = `Upload complete! Created: ${res.data.created.length}, Errors: ${res.data.errors.length}`;
            fileInput.value = '';
            loadUsers();
          } catch (err) {
            const errorMsg = err.response?.data?.message || 'Failed to upload users.';
            status.textContent = `Error: ${errorMsg}`;
          }
        }
    </script>
</body>
</html>