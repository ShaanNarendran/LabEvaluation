<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Faculty Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-100 min-h-screen font-sans">

  <div class="max-w-7xl mx-auto px-6 py-10">
    <div class="flex justify-between items-center mb-10">
      <div class="text-left">
        <h1 class="text-3xl font-extrabold text-purple-800">Faculty Dashboard</h1>
        <p class="text-gray-600 mt-2">Create, manage, and assign programming questions and modules.</p>
      </div>
      <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-full shadow">Logout</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      
      <div class="space-y-8">
        <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-purple-400">
          <h2 class="text-xl font-semibold text-purple-700 mb-4">Add New Question</h2>
          <form id="questionForm">
              <input id="title" type="text" placeholder="Question Title" required class="w-full p-3 mb-3 border rounded-lg" />
              <textarea id="description" placeholder="Problem Description" rows="4" required class="w-full p-3 mb-3 border rounded-lg"></textarea>
              <input id="marks" type="number" placeholder="Marks" value="10" required class="w-full p-3 mb-3 border rounded-lg" />
              <select id="language" required class="w-full p-3 mb-3 border rounded-lg">
                  <option selected disabled>Select Programming Language</option>
                  <option value="c">C</option>
                  <option value="cpp">C++</option>
                  <option value="java">Java</option>
                  <option value="python">Python</option>
              </select>
              <div id="testcaseContainer" class="space-y-2 mb-3">
                  <div class="flex gap-2">
                      <input type="text" placeholder="Input" class="test-input flex-1 p-2 border rounded" />
                      <input type="text" placeholder="Expected Output" class="expected-output flex-1 p-2 border rounded" />
                  </div>
              </div>
              <button type="button" onclick="addTestCase()" class="text-sm text-blue-600 hover:underline mb-4">+ Add another test case</button>
              <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2 rounded-full shadow">Add Question to Bank</button>
          </form>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-green-400">
          <h2 class="text-xl font-semibold text-green-700 mb-4">Module Management</h2>
          <div class="mb-4 space-y-3">
            <input id="moduleTitle" type="text" placeholder="New Module Title (e.g., Midterm Exam)" class="w-full p-3 border rounded-lg" />
            <input id="moduleCourseCode" type="text" placeholder="Course Code (e.g., CS101)" class="w-full p-3 border rounded-lg" />
            <input id="moduleWeekNumber" type="number" placeholder="Week Number" class="w-full p-3 border rounded-lg" />
            <p class="text-sm text-gray-500">Select questions from the list on the right, then click the button below to create a module.</p>
            <button id="createModuleBtn" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-full shadow">Create New Module</button>
            <p id="moduleStatus" class="mt-3 text-sm"></p>
          </div>
        </div>
        
        <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-blue-400">
          <h2 class="text-xl font-semibold text-blue-700 mb-4">Bulk Upload Questions</h2>
          <input type="file" id="bulkFile" accept=".json,.xlsx,.xls,.csv" class="mb-2">
          <p class="text-sm text-gray-500 mb-3">Format: Array of objects with title, description, languages, marks, testCases[]</p>
          <button id="uploadBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-full shadow">Upload Question File</button>
          <p id="uploadStatus" class="mt-3 text-sm text-gray-600"></p>
        </div>

      </div>

      <div class="space-y-8">
          <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-yellow-400">
            <h2 class="text-xl font-semibold text-yellow-700 mb-4">Available Questions</h2>
            <div id="questionList" class="space-y-2 text-gray-700 text-sm max-h-96 overflow-y-auto">
                <li class="text-gray-500">Loading questions...</li>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-indigo-400">
            <h2 class="text-xl font-semibold text-indigo-700 mb-4">Assign to Students</h2>
            <div class="space-y-4">
              <div>
                <label for="batchSelect" class="font-semibold text-gray-700 block mb-1">Select Batch & Semester:</label>
                <select id="batchSelect" class="w-full p-3 border rounded-lg">
                    <option>Loading batches...</option>
                </select>
              </div>
              
              <div>
                <label for="moduleSelect" class="font-semibold text-gray-700 block mb-1">Assign or Report on a Module:</label>
                <div class="flex items-center gap-2">
                    <select id="moduleSelect" class="flex-grow p-3 border rounded-lg">
                        <option>Loading modules...</option>
                    </select>
                    <button id="downloadReportBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg shadow" title="Download Report">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </button>
                </div>
                
                <div class="mt-3">
                    <label for="randomCount" class="font-semibold text-gray-700 block mb-1">Number of Random Questions</label>
                    <input type="number" id="randomCount" placeholder="Leave blank to assign all" class="w-full p-3 border rounded-lg">
                </div>
                
                <button id="assignModuleBtn" class="mt-3 bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg shadow">Assign Module</button>
              </div>

              <p id="assignStatus" class="mt-3 text-sm"></p>
            </div>
          </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    const axiosInstance = axios.create({ baseURL: '/api' });

    document.addEventListener('DOMContentLoaded', () => {
        loadInitialData();
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        document.getElementById('questionForm').addEventListener('submit', handleAddQuestion);
        document.getElementById('createModuleBtn').addEventListener('click', handleCreateModule);
        document.getElementById('assignModuleBtn').addEventListener('click', handleAssignModule);
        document.getElementById('uploadBtn').addEventListener('click', handleBulkQuestionUpload);
        document.getElementById('downloadReportBtn').addEventListener('click', handleDownloadReport);
    });

    async function loadInitialData() {
        try {
            const [questionsRes, modulesRes, batchesRes] = await Promise.all([
                axiosInstance.get('/faculty/questions'),
                axiosInstance.get('/module'),
                axiosInstance.get('/faculty/my-batches')
            ]);
            renderQuestions(questionsRes.data);
            renderModules(modulesRes.data);
            renderBatches(batchesRes.data);
        } catch (err) {
            console.error("Error loading initial data", err);
            alert('Failed to load dashboard data. Please try logging in again.');
        }
    }

    function renderQuestions(questions) {
        const ul = document.getElementById("questionList");
        ul.innerHTML = questions.length === 0
            ? "<li class='text-gray-500'>No questions added yet.</li>"
            : questions.map(q => `
                <li class="bg-gray-50 p-3 rounded-lg flex justify-between items-center">
                    <div class="flex items-center">
                        <input type="checkbox" class="h-4 w-4 mr-4 question-checkbox" data-id="${q._id}">
                        <label class="font-medium">${q.title}</label>
                    </div>
                    <button onclick="deleteQuestion('${q._id}')" class="text-red-500 hover:underline text-xs">Delete</button>
                </li>
            `).join('');
    }

    function renderModules(modules) {
        const select = document.getElementById("moduleSelect");
        select.innerHTML = modules.length === 0 
            ? '<option>No modules created yet.</option>'
            : '<option selected disabled>Select a module</option>' + modules.map(m => `<option value="${m._id}">${m.title}</option>`).join('');
    }

    function renderBatches(batches) {
        const select = document.getElementById("batchSelect");
        const uniqueBatches = [...new Map(batches.map(item => [`${item.batch}-${item.semester}`, item])).values()];
        
        select.innerHTML = uniqueBatches.length === 0
            ? '<option>No batches assigned to you.</option>'
            : '<option selected disabled>Select a batch/semester</option>' + uniqueBatches.map(b => `<option value='${JSON.stringify(b)}'>Batch ${b.batch} - Semester ${b.semester}</option>`).join('');
    }

    async function handleAssignModule() {
        console.log("%c--- [FRONTEND DEBUG] ASSIGNMENT INITIATED ---", "color: blue; font-weight: bold;");
        const batchSelect = document.getElementById('batchSelect');
        const moduleSelect = document.getElementById('moduleSelect');
        const randomCountInput = document.getElementById('randomCount');
        const statusEl = document.getElementById('assignStatus');

        if (batchSelect.selectedIndex <= 0 || moduleSelect.selectedIndex <= 0) {
            statusEl.textContent = 'Error: Please select both a batch and a module.';
            statusEl.style.color = 'red';
            return;
        }

        const { batch, semester } = JSON.parse(batchSelect.value);
        const moduleId = moduleSelect.value;
        const randomCount = parseInt(randomCountInput.value, 10);
        
        const payload = { moduleId, batch, semester };
        if (!isNaN(randomCount) && randomCount > 0) {
            payload.randomCount = randomCount;
        }
        
        console.log("[FRONTEND DEBUG] Sending payload to server:", payload);

        try {
            const res = await axiosInstance.post('/faculty/modules/assign', payload);
            console.log("[FRONTEND DEBUG] Server responded successfully:", res.data);
            statusEl.textContent = res.data.message;
            statusEl.style.color = 'green';
        } catch (err) {
            console.error("[FRONTEND DEBUG] Server responded with an error:", err.response?.data);
            statusEl.textContent = `Error: ${err.response?.data?.message || 'Assignment failed.'}`;
            statusEl.style.color = 'red';
        }
    }
    
    // --- Other functions (handleBulkQuestionUpload, handleCreateModule, etc.) ---
    async function handleDownloadReport() {
        const moduleSelect = document.getElementById('moduleSelect');
        if (moduleSelect.selectedIndex <= 0) {
            alert('Please select a module to generate a report.');
            return;
        }
        const moduleId = moduleSelect.value;
        window.location.href = `/api/faculty/modules/${moduleId}/report`;
    }
    
    async function handleBulkQuestionUpload() {
      const fileInput = document.getElementById("bulkFile");
      const status = document.getElementById("uploadStatus");
      const file = fileInput.files[0];
      if (!file) { status.textContent = "Please select a file."; return; }

      const formData = new FormData();
      formData.append("file", file);
      status.textContent = "Uploading...";
      try {
        const res = await axiosInstance.post('/faculty/bulk', formData);
        status.textContent = res.data.message || "Upload complete!";
        fileInput.value = '';
        loadInitialData();
      } catch (err) {
        const errorMsg = err.response?.data?.message || "Failed to upload questions.";
        status.textContent = `Error: ${errorMsg}`;
        console.error("Bulk question upload error", err);
      }
    }

    async function handleCreateModule() {
        const title = document.getElementById('moduleTitle').value.trim();
        const courseCode = document.getElementById('moduleCourseCode').value.trim();
        const weekNumber = document.getElementById('moduleWeekNumber').value;
        const selectedCheckboxes = document.querySelectorAll('.question-checkbox:checked');
        const questionIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);
        const statusEl = document.getElementById('moduleStatus');

        if (!title || !courseCode || !weekNumber) {
            statusEl.textContent = 'Error: Module Title, Course Code, and Week Number are required.';
            statusEl.style.color = 'red';
            return;
        }
        if (questionIds.length === 0) {
            statusEl.textContent = 'Error: Please select at least one question for the module.';
            statusEl.style.color = 'red';
            return;
        }

        try {
            await axiosInstance.post('/module', { 
                title, 
                courseCode, 
                weekNumber: parseInt(weekNumber), 
                questions: questionIds 
            });
            statusEl.textContent = `Module "${title}" created successfully!`;
            statusEl.style.color = 'green';
            document.getElementById('moduleTitle').value = '';
            document.getElementById('moduleCourseCode').value = '';
            document.getElementById('moduleWeekNumber').value = '';
            loadInitialData();
        } catch (err) {
            statusEl.textContent = 'Error creating module.';
            statusEl.style.color = 'red';
            console.error(err);
        }
    }
    
    async function handleLogout() {
      try {
        await axiosInstance.post('/auth/logout');
      } finally {
        window.location.href = '/faculty-login.html';
      }
    }

    function addTestCase() {
        const container = document.getElementById("testcaseContainer");
        const div = document.createElement("div");
        div.className = "flex gap-2 mb-2";
        div.innerHTML = `<input type="text" placeholder="Input" class="test-input flex-1 p-2 border rounded" /><input type="text" placeholder="Expected Output" class="expected-output flex-1 p-2 border rounded" />`;
        container.appendChild(div);
    }
    
    async function handleAddQuestion(e) {
      e.preventDefault();
      const testCases = Array.from(document.querySelectorAll("#testcaseContainer > div")).map(div => ({
        input: div.querySelector(".test-input").value,
        expected: div.querySelector(".expected-output").value
      }));

      const payload = {
          title: document.getElementById('title').value,
          description: document.getElementById('description').value,
          marks: parseInt(document.getElementById('marks').value),
          languages: [document.getElementById('language').value],
          testCases
      };
      
      try {
        await axiosInstance.post('/faculty/questions', payload);
        alert("Question added successfully!");
        e.target.reset();
        loadInitialData();
      } catch (err) {
        alert("Error: Failed to save question.");
      }
    }

    async function deleteQuestion(id) {
        if (!confirm("Are you sure? This will remove the question from the bank and all modules.")) return;
        try {
            await axiosInstance.delete(`/faculty/questions/${id}`);
            alert("Question deleted.");
            loadInitialData();
        } catch (err) {
            alert("Error deleting question.");
        }
    }
</script>

</body>
</html>